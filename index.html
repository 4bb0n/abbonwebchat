<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Chat</title>
    <style>
      body {
        max-width: 100%;
        overflow-x: hidden;
      }

      input {
        height: 100px;
        width: 200px;
        border-radius: 15px;
        font-size: 20px;
        border-width: 1px;
        font-family: monospace;
        background-color: rgb(0, 8, 33);
        color: white;
        box-shadow: none;
      }

      #chat-display {
        height: 400px;
        width: 100%;
        font-size: 20px;
        background-color: #f5f5f5;
        font-family: sans-serif;
        padding-top: 10px;
        padding-bottom: 10px;
        border-width: 10px;
        border-color: black;
        overflow-y: scroll;
      }
      .myMessage {
        width: 1000px;
        position: relative;
        height: auto;
        background-color: #dddce2;
        opacity: 5;
        margin: 10px;
        border-radius: 10px;
        color: black;
        padding: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .senderMessage {
        width: 1000px;
        position: relative;
        left: 31%;
        height: auto;
        background-image: linear-gradient(#53bbf0, #258ff4);
        opacity: 5;
        margin: 10px;
        border-radius: 10px;
        color: white;
        text-align: left;
        font-family: helvetica;
        padding: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .triangle {
        width: 0px;
        height: 0px;
        border-style: solid;
        border-width: 0 5px 32px 5px;
        border-color: transparent transparent #258ff4 transparent;
        transform: rotate(136deg);
      }
      button {
        height: 80px;
        width: 160px;
        background-color: lime;
        border-radius: 15px;
        font-size: larger;
        border-width: 1px;
        box-shadow: 2px 2px 2px black;
        cursor: pointer;
        font-family: Impact, fantasy;
      }
      #send {
        border-radius: 15px;
        padding: 30px;
        width: 140px;
        text-align: center;
        margin: auto;
        font-family: Impact, fantasy;
        font-size: 24px;
        height: 40px;
        position: relative;
        top: 15px;
      }
      #send:hover {
        background-color: rgb(51, 151, 217);
      }
      #send:active {
        background-color: rgb(51, 151, 217);
      }
      #chat-input {
        box-shadow: 3px 3px 2px;
        border-width: 3px;
        border-color: #000000;
        width: 85%;
        height: 50px;
        font-family: helvetica;
        background-color: whitesmoke;
        color: black;
        border-radius: 30px;
        padding-left: 20px;
        box-shadow: none;
        border-radius: 15px;
      }
      #chat-input:active {
        border-color: #dbdbdb;
      }
      pre {
        font-size: 24px;
        font-weight: bold;
        font-family: monospace;
      }
      #loginBtn {
        background-color: rgb(224, 224, 224);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        border-radius: 0;
        width: 100px;
        height: 50px;
        position: relative;
        bottom: 30px;
        left: 70px;
        top: 50px;
      }
      #loginBtn:hover {
        background-color: rgb(240, 240, 240);
      }
      #password {
        height: 40px;
        position: relative;
        left: 20px;
        box-shadow: 2px 2px 2px;
        text-align: center;
        font-family: Trebuchet MS, sans-serif;
        font-weight: bold;
        top: 55px;
      }
      #note {
        font-size: 10x;
        position: relative;
        left: 70px;
        color: red;
        top: 50px;
      }
      #file-input {
        height: 50px;
        border-radius: 0;
        border: solid 5px black;
        background-color: white;
        color: black;
        padding: 10px;
        padding-top: 0px;
        text-align: center;
        top: 50px;
      }
      @keyframes rainbowText {
        10% {
          color: red;
        }
        20% {
          color: orangered;
        }
        25% {
          color: rgb(255, 111, 0);
        }
        30% {
          color: yellow;
        }
        35% {
          color: yellowgreen;
        }
        40% {
          color: lime;
        }
        45% {
          color: green;
        }
        50% {
          color: rgb(0, 255, 251);
        }
        55% {
          color: rgb(0, 123, 255);
        }
        60% {
          color: rgb(21, 0, 255);
        }
        70% {
          color: rgb(123, 0, 255);
        }
        80% {
          color: rgb(242, 0, 255);
        }
        90% {
          color: rgb(255, 0, 123);
        }
        100% {
          color: rgb(255, 0, 0);
        }
      }
      @keyframes rainbowBackground {
        10% {
          background-color: red;
        }
        20% {
          background-color: orangered;
        }
        25% {
          background-color: rgb(255, 111, 0);
        }
        30% {
          background-color: yellow;
        }
        35% {
          background-color: yellowgreen;
        }
        40% {
          background-color: lime;
        }
        45% {
          background-color: green;
        }
        50% {
          background-color: rgb(0, 255, 251);
        }
        55% {
          background-color: rgb(0, 123, 255);
        }
        60% {
          background-color: rgb(21, 0, 255);
        }
        70% {
          background-color: rgb(123, 0, 255);
        }
        80% {
          background-color: rgb(242, 0, 255);
        }
        90% {
          background-color: rgb(255, 0, 123);
        }
        100% {
          background-color: rgb(255, 0, 0);
        }
      }
      #username {
        height: 40px;
        text-align: center;
        font-family: Trebuchet MS, sans-serif;
        font-weight: bold;
        box-shadow: 2px 2px 2px;
        position: relative;
        left: 20px;
        top: 50px;
      }
      #userInfo {
        position: relative;
        left: 1059px;
        bottom: 100px;
      }
      #file-send-button {
        height: 40px;
        border-radius: 0;
        background-color: rgb(0, 0, 41);
        color: white;
        position: relative;
        top: 5px;
        left: 25px;
        box-shadow: 2px 2px 2px lime;
        border-left: solid 10px rgb(0, 179, 255);
        top: 30px;
      }
      @keyframes border-left-appear {
        0% {
          border-left: solid 10px rgb(0, 179, 255);
        }
        100% {
          border-left: solid 10px red;
        }
      }
      @keyframes border-right-appear {
        0% {
          border-right: solid 10px rgb(0, 179, 255);
        }
        100% {
          border-right: solid 10px red;
        }
      }
      #file-send-button:hover {
        background-color: rgb(0, 0, 70);
        animation-name: border-left-appear;
        animation-duration: 0.5s;
        animation-iteration-count: infinite;
        animation-timing-function: linear;
      }
      h3 {
        color: white;
        text-align: center;
      }
      #ai {
        position: absolute;
        left: 500px;
        top: 800px;
        width: 1000px;
      }

      #clearAllMsg{
        height:70px;
        width: 200px;
        border-radius:0;
        background-color: lightgray;
        margin-top: 15px;
        font-family: sans-serif;
        font-weight: bold;
        box-shadow:gray;
        margin-bottom: 15px;
        position:relative;
        bottom: 12px;
        left: 20px;
      }
      #messageSettings{
        color:black;
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-decoration: underline rgb(108, 108, 255);
        background-color: rgb(157, 165, 255);
        width: 200px;
        padding: 15px;
        position:relative;
        left: 45%;
        bottom: 20px;
      }
      #removeLastMsg{
        height:70px;
        width: 200px;
        border-radius:0;
        background-color: lightgray;
        margin-top: 15px;
        font-family: sans-serif;
        font-weight: bold;
        box-shadow:gray;
        left:50px;
        margin-left: 40px;
      }
      #darkMode{
        border-radius: 2px;
        background-color: rgb(0, 0, 85);
        color: lightgray;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        font-weight: 600;
        box-shadow: 3px 3px gray;
      }
      #lightMode{
        border-radius: 2px;
        position:relative;
        left: 20px;
        background-color: rgba(245, 245, 245, 0.905);
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: 600;
      }
      #speechBoxColour{
        color: black;
        font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: 600;
      }
      #darkBlueSpeechBox{
        border-radius: 5px;
        font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        background-color: darkblue;
        color:white;
      }
      #targetUser{
        border-radius: 5px;
        height: 50px;
        width: 200px;
        text-align: center;
      }
      #kickUserButton{
        height: 50px;
        border-radius: 0;
        position: relative;
        left: 20px;
        background-color: #dbdbdb;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: bold;
        font-size: large;
      }
      .kickMessage{
        width: 1000px;
        position: relative;
        left: 20%;
        text-align: center;
        height: auto;
        background-color: #dddce2;
        opacity: 5;
        margin: 10px;
        border-radius: 10px;
        color: red;
        padding: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-shadow: 0px 0px 5px red;
      }
      #room{
        height: 50px;
        border-radius: 2px;
        background-color: lightgray;
        color: black;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        text-align: center;
        box-shadow: 2px 2px 2px black;
      }
      #roomLeave{
        position: relative;
        top: 13px;
        height: 50px;
        border-radius: 2px;
        background-color: lightgray;
        color: black;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        text-align: center;
        box-shadow: 2px 2px 2px black;
      }
      #joinRoom{
        position: relative;
        background-color: rgb(61, 255, 80);
        left: 15px;
        border-radius: 0;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: bold;
        font-size: 20;
      }
      #leaveRoom{
        position: relative;
        top: 10px;
        background-color: rgb(250, 45, 45);
        left: 15px;
        border-radius: 0;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: bold;
        font-size: 20;
      }
    </style>
  </head>
  <body>
    <div id="chat-display" readonly></div>
    <form id="chat-form">
      <input
        id="chat-input"
        type="text"
        autocomplete="off"
        contenteditable="on"
        placeholder="Type a message..." />
      <button id="send" type="submit">Send</button>
    </form>
    <input type="file" id="file-input" />
    <button id="file-send-button">SEND FILE</button>
    <div id="progressContainer">
      <div
        id="progressBar"
        style="width: 1%; height: 20px; background-color: lime"></div>
    </div>
    <div id="userInfo">
      <input placeholder="username" id="username" autocomplete="off" type="username"><br />
      <input
        type="password"
        id="password"
        placeholder="password*"
        autocomplete="off" />
      <p id="note">*for admins only!</p>
      <br />
      <button id="loginBtn">Login</button>
    </div>
    <pre id="userOnline">Users online: 
0</pre>
    <input type="text" id="room" placeholder="room"/>
    <button id="joinRoom">join room</button>
    <br>
    <input type="text" id="roomLeave" placeholder="room">
    <button id="leaveRoom">leave room</button>
    <br />
    <br />
    <hr />
    <h2 id="settings">SETTINGS</h2>
    <pre>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </pre>
    <br />
    <h3 id="speechBoxColour">speech box colour</h3>
    <button id="darkBlueSpeechBox">Dark Blue</button>
    <pre>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </pre>
    <div id="background-color-mode">
      <button id="darkMode">Dark Mode</button>
      <button id="lightMode">Light Mode</button>
    </div>
    <pre>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </pre>
    <div id="Messages">
      <h3 id="messageSettings">Message Settings</h3>
      <pre>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </pre>
      <button id="clearAllMsg">Clear All Messages</button>
      <button id="removeLastMsg">Remove Last Message</button>
    </div>
    <hr />
    <div id="AdminUIContainer" style="display: none">
      <h3 id="adminUI" style="color:red;">Admin Panel</h3>
      <input type="text" placeholder="username to kick" id="targetUser"/>
      <button id="kickUserButton">Kick User</button>
      <br>
      <pre>Users Online:

      </pre>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="index.cjs"></script>
    <script>
      const socket = io();
      const form = document.getElementById("chat-form");
      const input = document.getElementById("chat-input");
      const chatDisplay = document.getElementById("chat-display");
      const fileInput = document.getElementById("file-input");
      const fileSendButton = document.getElementById("file-send-button");
      const sendBtn = document.getElementById("send");
      const usernameInput = document.getElementById("username");
      const offNot = document.getElementById("offnot");
      const password = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");
      const darkMode = document.getElementById("darkMode");
      const lightMode = document.getElementById("lightMode");
      Notification.requestPermission();
      const aiIframe = document.getElementById("ai");
      const clearAllMsg = document.getElementById("clearAllMsg");
      const removeLastMsg = document.getElementById("removeLastMsg");
      const darkBlueSpeechBoxBtn = document.getElementById("darkBlueSpeechBox");
      const chatDisplayForm = document.getElementById("chat-display-form");
      const joinRoom = document.getElementById("joinRoom");
      const leaveRoom = document.getElementById("leaveRoom");
      const room = document.getElementById("room");
      const roomLeave = document.getElementById("roomLeave");
      const usersOnlineList = document.getElementById("usersOnlineList");

      socket.on('getName', () => {
        const username = document.getElementById("username").value;
        socket.emit("getName2", username, socket.id);
      })
      
      socket.on('nameAndId', (username, id) => {
        setTimeout(() => {
          usersOnlineList.textContent = `${username} : ${id}`
          console.log('nameAndId', username, id)
        }, 200)
      })

      leaveRoom.addEventListener("click", () => {
        appendMessage(`You have left room: ${roomLeave.value}`);
        socket.emit("leave room", roomLeave.value);
      })

      joinRoom.addEventListener("click", () => {
        appendMessage(`You have joined room: ${room.value}`);
        socket.emit("join room", room.value);
      })

      socket.on("user count", numUser => {
        document.getElementById("userOnline").textContent = `Users online:
${numUser}`;
      })

      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("Notification permission granted.");
        } else {
          console.log("Notification permission denied.");
        }
      });

      function showNotification(msg) {
        const username = msg.split(":")[0]; // Extract username from msg
        const messageContent = msg.split(":").slice(1).join(":").trim(); // Extract message content
        if (Notification.permission === "granted") {
          new Notification(`New message from ${username.value}`, {
            body: messageContent,
          });
          console.log("Notification sent" + messageContent);
        }
      }


      loginBtn.addEventListener("click", () => {
        const password = document.getElementById("password").value;
        localStorage.setItem("password", password);
        if(password == "stcxkl@ctdvn"){
          document.getElementById("AdminUIContainer").style.display = "initial"
      }
    }
  )

      clearAllMsg.addEventListener("click", () => {
        localStorage.removeItem("chatMessages");
        chatDisplay.innerHTML = "Message Cleared";
      })

      removeLastMsg.addEventListener("click", () => {
        const messages = loadMessagesFromLocalStorage();
        if (messages.length > 0) {
          messages.pop();
          saveMessagesToLocalStorage(messages);
          const removedLastMsgWarning = document.createElement("p");
          removedLastMsgWarning.textContent = "[Last Message Removed]"
          chatDisplay.appendChild(removedLastMsgWarning);
          document.getElementsByClassName("senderMessage").pop().remove();
        }
      })

      // Load saved username from local storage
      window.onload = function () {
        const savedUsername = localStorage.getItem("username");
        if (savedUsername) {
          usernameInput.value = savedUsername;
        }
      };

      // Save username to local storage
      usernameInput.addEventListener("input", function () {
        localStorage.setItem("username", usernameInput.value);
      });

      socket.on("force chat2", (msg) => {
        socket.emit("chat message", msg);
      });

      // Function to save messages to local storage
      function saveMessagesToLocalStorage(messages) {
        localStorage.setItem("chatMessages", JSON.stringify(messages));
      }

      // Function to load messages from local storage
      function loadMessagesFromLocalStorage() {
        try {
          return JSON.parse(localStorage.getItem("chatMessages")) || [];
        } catch (error) {
          console.error("Error loading messages from local storage:", error);
          return [];
        }
      }

      // Function to add a new message
      function addMessage(type, content) {
        let messages = loadMessagesFromLocalStorage();
        const newMessage = { type, content, timestamp: Date.now() };
        messages.push(newMessage);
        saveMessagesToLocalStorage(messages);
        return newMessage;
      }

      // Function to display messages
      function displayMessages(messages) {
        const chatDisplay = document.getElementById("chat-display");
        messages.forEach((message) => {
          if (message.type === "sender") {
            appendSenderMessage(message.content);
          } else {
            appendMessage(message.content); 
          }
        });
      }

      // Modify your existing socket.on('chat message') handler
      socket.on("chat message", (msg) => {
        msg = msg
        .replaceAll("sigma", "*FORBIDDEN WORD*")
            .replaceAll("ohio", "*FORBIDDEN WORD*")
            .replaceAll("skibidi", "*FORBIDDEN WORD*")
            .replaceAll("rizzler", "*FORBIDDEN WORD*")
            .replaceAll("rizz", "*FORBIDDEN WORD*")
            .replaceAll("OHIO", "*FORBIDDEN WORD*")
            .replaceAll("SKIBIDI", "*FORBIDDEN WORD*")
            .replaceAll("RIZZLER", "*FORBIDDEN WORD*")
            .replaceAll("RIZZ", "*FORBIDDEN WORD*")
            .replaceAll("SIGMA", "*FORBIDDEN WORD*");
        const newMessage = addMessage("received", msg);
        appendMessage(newMessage.content);
        showNotification(msg);
      });

      // Modify your form submit event handler
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          input.value = input.value
            .replaceAll("sigma", "*FORBIDDEN WORD*")
            .replaceAll("ohio", "*FORBIDDEN WORD*")
            .replaceAll("skibidi", "*FORBIDDEN WORD*")
            .replaceAll("rizzler", "*FORBIDDEN WORD*")
            .replaceAll("rizz", "*FORBIDDEN WORD*")
            .replaceAll("OHIO", "*FORBIDDEN WORD*")
            .replaceAll("SKIBIDI", "*FORBIDDEN WORD*")
            .replaceAll("RIZZLER", "*FORBIDDEN WORD*")
            .replaceAll("RIZZ", "*FORBIDDEN WORD*")
            .replaceAll("SIGMA", "*FORBIDDEN WORD*");
          const username = usernameInput.value;
          const senderMessage = input.value;
          const newMessage = addMessage("sender", "YOU: " + senderMessage);
          appendSenderMessage(newMessage.content);
          const room = document.getElementById("room").value;
          socket.emit("chat message", `${username} : ${senderMessage}`, room);
          input.value = "";
          chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }
      });

      // Keep your existing appendMessage and appendSenderMessage functions
      function appendMessage(msg) {
        const chatDisplay = document.getElementById("chat-display");
        const myMessage = document.createElement("div");
        myMessage.classList.add("myMessage");
        chatDisplay.appendChild(myMessage);
        myMessage.textContent = msg;
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
      }

      function appendSenderMessage(msg) {
        const chatDisplay = document.getElementById("chat-display");
        const myMessage = document.createElement("div");
        const deleteBtn = document.createElement("button")
        myMessage.classList.add("senderMessage");
        myMessage.contentEditable = true;
        chatDisplay.appendChild(myMessage);
        myMessage.textContent = msg;
        console.log("chatDisplay updated. New value:", myMessage.textContent);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
      }
      function appendKickMessage(msg) {
        const chatDisplay = document.getElementById("chat-display");
        const myMessage = document.createElement("div");
        myMessage.classList.add("kickMessage");
        chatDisplay.appendChild(myMessage);
        myMessage.textContent = msg;
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
      }

      // Load and display messages when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        const fileMessages = loadFileMessagesFromLocalStorage();
        displayFileMessages(fileMessages);
        
        const messages = loadMessagesFromLocalStorage();
        displayMessages(messages);

        const password = localStorage.getItem("password");
        document.getElementById("password").value = password;
        if(password == "stcxkl@ctdvn"){
          document.getElementById("AdminUIContainer").style.display = "initial"
      }
      });

      // force kick packet receiver
      socket.on("new message notification", (msg) => {
          let notification1 = new Notification(`New message from ${username.value}`, {
            body: msg,
          });
          console.log(notification1)
      });

      socket.on("sender message",
      setTimeout(() => {
      socket.emit('get socketID')
    }, 50));
    socket.on('socket ID', (id) => {
      appendMessage("You Joined on " + new Date() + ' your id is:              \n \n ' + id);
      const username = localStorage.getItem("username");
      socket.emit('userjoined', username, new Date())
      addMessage("received", "You Joined on "+ new Date());
    })

    socket.on("userjoined", (username, time) => {
      appendMessage(`${username} has joined on ` + time);
      addMessage("received", `${username} has joined on `+time);
    })

      socket.on("notification", (msg) => {
        if (notificationsEnabled && Notification.permission === "granted") {
          const username = msg.split(">")[0].substr(1);
          const message = msg.split(">")[1].trim();
          new Notification(`New message from ${username}`, {
            body: message,
          });
          soundeffect.play();
        }
      });

      const targetUser = document.getElementById("targetUser");
      const kickUserButton = document.getElementById("kickUserButton");
      kickUserButton.onclick = () => {
        const targetUsername = targetUser.value;
        socket.emit("kick-user", targetUsername);
        appendKickMessage(`${targetUsername} has been kicked!`);
        addKickMessage("received", `${targetUsername} has been kicked!`);
      };
      socket.on("kick-user", (targetUsername) => {
        kickUser(targetUsername)
      })
      function kickUser(targetUsername){
        const username = document.getElementById("username").value;
        console.log(targetUsername)
        if(targetUsername == username){
          let lastWords = window.prompt("You're about to be kicked! Any last words?")
          appendMessage("You have been kicked / Disconnected! Refresh the page to join again!");
          const targetUsername = targetUser.value;
          socket.emit("force disconnect", targetUsername);
          console.log('targetUsername = ' + targetUser.value)
        }
      }
      socket.on('force disconnect broadcast alert message', targetUsername => {
        appendKickMessage(targetUsername +' has been kicked!');
      })
      // Get the user's IPv4 address
      const getIPv4Address = () => {
        fetch("https://api.ipify.org?format=json")
          .then((response) => response.json())
          .then((data) => socket.emit("ip", data.ip))
          .catch((error) => console.error("Error fetching IP address:", error));
      };

      // Call the function to log the IPv4 address
      getIPv4Address();

      fileSendButton.onclick = sendFile;

      function sendFile() {
        const file = fileInput.files[0];
        if (file) {
          const progressContainer =
            document.getElementById("progressContainer");
          const progressBar = document.getElementById("progressBar");

          progressContainer.style.display = "block"; // Show progress container
          progressBar.style.width = "0%"; // Reset progress bar

          const reader = new FileReader();

          reader.onload = function (e) {
            const fileContent = e.target.result.split(",")[1]; // Get Base64 string from Data URL
            socket.emit("send-file", {
              fileName: file.name,
              fileContent: fileContent, // Already in Base64 format
            });
          };

          reader.readAsDataURL(file); // Read as Data URL for Base64 encoding

          // Create a new XMLHttpRequest to handle the upload progress
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "http://localhost:3000/uploads"); // Replace with your server endpoint

          xhr.upload.addEventListener("progress", function (event) {
            if (event.lengthComputable) {
              const percentComplete = (event.loaded / event.total) * 100;
              progressBar.style.width = percentComplete + "%";
            }
          });

          xhr.onload = function () {
            fileInput.value = ""; // Reset file input
            progressBar.style.width = "1%";
          };

          xhr.onerror = function () {
            console.error("An error occurred during the file upload.");
          };

          // Send the file using FormData
          const formData = new FormData();
          formData.append("file", file);
          xhr.send(formData);
        }
        fileInput.value = "";

        const file1 = fileInput.files[0];
    if (file1) {
        const reader = new FileReader();

        reader.onload = function (e) {
            const fileContent = e.target.result.split(",")[1]; // Get Base64 string from Data URL
            const fileUrl = URL.createObjectURL(new Blob([new Uint8Array(atob(fileContent).split("").map(c => c.charCodeAt(0)))]));
            socket.emit("send-file", { fileName: file1.name, fileContent: fileContent });

            // Save the file message in localStorage
            const fileMessages = loadFileMessagesFromLocalStorage();
            fileMessages.push(fileUrl);
            saveFileMessagesToLocalStorage(fileMessages);
            appendFileMessage(fileUrl); // Display immediately
        };

        reader.readAsDataURL(file1); // Read the file as Data URL
    }

      }

      // Update the file-received handler
      socket.on("file-received", (data) => {
        const { fileName, fileContent } = data;
        const fileUrl = URL.createObjectURL(
          new Blob([
            new Uint8Array(
              atob(fileContent)
                .split("")
                .map((c) => c.charCodeAt(0))
            ),
          ])
        );

        const fileLink = document.createElement("a");
        fileLink.href = fileUrl;
        fileLink.download = fileName;
        fileLink.textContent = `${fileName}`;
        fileLink.className = "file-download-link";

        const fileMessage = document.createElement("div");
        fileMessage.className = "senderMessage";
        fileMessage.textContent = ``;
        fileMessage.appendChild(fileLink);
      
        chatDisplay.appendChild(fileMessage);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;

        addFileMessage("received", fileName);  
      });

  // Function to save file messages to local storage
  function saveFileMessagesToLocalStorage(fileMessages) {
    localStorage.setItem("fileMessages", JSON.stringify(fileMessages));
    socket.emit("file-messages", fileMessages.textContent);
  }

  // Function to load file messages from local storage
  function loadFileMessagesFromLocalStorage() {
    try {
      return JSON.parse(localStorage.getItem("fileMessages")) || [];
    } catch (error) {
      console.error("Error loading file messages from local storage:", error);
      return [];
    }
  }

  // Function to display file messages
  function displayFileMessages(fileMessages) {
    fileMessages.forEach((message) => {
      appendFileMessage(message.content);
    });
  }

  // Function to add a file message
  function addFileMessage(type, content) {
    let fileMessages = loadFileMessagesFromLocalStorage();
    const newFileMessage = { type, content, timestamp: Date.now() };
    fileMessages.push(newFileMessage);
    saveFileMessagesToLocalStorage(fileMessages);
    return newFileMessage;
  }

  // Append file message to chat display
  function appendFileMessage(msg) {
    const fileMessage = document.createElement("div");
    const fileLink = document.createElement("a");
    fileLink.textContent = msg;
    fileLink.href = `/uploads/${msg}`;
    fileLink.download = msg.split('/').pop(); // Use the file name as the download name
    fileMessage.classList.add("senderMessage");
    fileMessage.appendChild(fileLink);
    chatDisplay.appendChild(fileMessage);
    chatDisplay.scrollTop = chatDisplay.scrollHeight;
    const test = localStorage.getItem("fileMessages");
    console.log(msg);
}

  // Clear all messages
  clearAllMsg.addEventListener("click", () => {
    localStorage.removeItem("chatMessages");
    localStorage.removeItem("fileMessages");
    chatDisplay.innerHTML = "Message Cleared";
  });

  // Remove last message
  removeLastMsg.addEventListener("click", () => {
    const messages = loadMessagesFromLocalStorage();
    const fileMessages = loadFileMessagesFromLocalStorage();
    if (messages.length > 0) {
      messages.pop();
      saveMessagesToLocalStorage(messages);
      chatDisplay.innerHTML = "Last Message Removed";
      displayMessages(messages);
    }
    if (fileMessages.length > 0) {
      fileMessages.pop();
      saveFileMessagesToLocalStorage(fileMessages);
      displayFileMessages(fileMessages);
    }
  });

      function base64ToBlob(base64, type) {
        const byteCharacters = atob(base64);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += 512) {
          const slice = byteCharacters.slice(offset, offset + 512);
          const byteNumbers = new Array(slice.length);
          for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, { type: type });
      }

      socket.on("file-error", (errorMessage) => {
        console.error("File error:", errorMessage);
      });

      // dark mode and light mode function
      darkMode.addEventListener("click", () => {
        document.body.style.backgroundColor = "rgb(8, 0, 51)";
        username.style.backgroundColor = "white";
        password.style.backgroundColor = "white";
        username.style.color = "black";
        password.style.color = "black";
        chatDisplay.style.backgroundColor = "#005678";
        input.style.backgroundColor = "#6b6b6b";
        input.style.color = "white";
        input.placeholder.style.color = "white";
        const h3 = document.getElementsByTagName("h3");
        const h2 = document.getElementsByTagName("h2");
        const pre = document.getElementsByTagName("pre");
        const p = document.getElementsByTagName("p");
/*************  ✨ Codeium Command ⭐  *************/
        for (let i = 0; i < h3.length; i++) {
          h3[i].style.color = "white";
        }
        for (let i = 0; i < h2.length; i++) {
          h2[i].style.color = "white";
        }
        for (let i = 0; i < pre.length; i++) {
          pre[i].style.color = "white";
        }
        for (let i = 0; i < p.length; i++) {
          p[i].style.color = "white";
        }
        
/******  44e373d3-6bfa-4c98-9c44-a9c39e9088b4  *******/ 
      })

      lightMode.addEventListener("click", () => {
        document.body.style.backgroundColor = "white";
        username.style.backgroundColor = "black";
        password.style.backgroundColor = "black";
        username.style.color = "white";
        password.style.color = "white";
        chatDisplay.style.backgroundColor = "white";
        input.style.backgroundColor = "#dadada";
        input.style.color = "black";
        input.placeholder.style.color = "black";
        console.log("light mode");
      })

      darkBlueSpeechBoxBtn.addEventListener("click", () => {
        document.getElementsByClassName("senderMessage").style.backgroundImage = "linear-gradient(180deg, rgba(3,251,252,1) 23%, rgba(0,9,255,1) 100%);"
      })

      socket.on("connection", () => {
        console.log("Connected to server");
        socket.emit("join", userID);
      });


    </script>
  </body>
</html>
